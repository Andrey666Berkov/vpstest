name: Deploy FirstApiWeb to VPS

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Publish FirstApiWeb
        run: |
          set -e
          dotnet publish FirstApiWeb/FirstApiWeb.csproj -c Release -o out

      - name: Create release dir on VPS (timestamp)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            set -e
            TS="$(date +%Y%m%d_%H%M%S)"
            echo "RELEASE_DIR=/var/www/myfirstapp/releases/$TS" >> $GITHUB_ENV
            mkdir -p "/var/www/myfirstapp/releases/$TS"

      - name: Upload publish output to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          source: "out/*"
          target: "${{ env.RELEASE_DIR }}"

      - name: Switch current + restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            set -e
            sudo ln -sfn "${{ env.RELEASE_DIR }}" /var/www/myfirstapp/current
            sudo systemctl restart myfirstapp
            sudo systemctl --no-pager --full status myfirstapp || true
